---
date created: 2021-12-01 22:58
---

# 实验三 8259 中断

## 1. 实验目的

1. 掌握 8259 中断控制器的工作原理。
2. 学习 8259 的应用编程方法。
3. 掌握 8259 级联方式的使用方法。

## 2. 实验内容

1. 利用系统总线上中断请求信号 MIR7，设计一个单一中断请求实验。
2. 利用系统总线上中断请求信号 MIR6 和 MIR7，设计一个双中断优先级应用实验，观察 8259 对中断优先级的控制。
3. 利用系统总线上中断请求信号 MIR7 和 SIR1，设计一个级连中断应用实验。

## 3. 实验原理

### 3.1. 中断控制器 8259 简介

在 Intel 386EX 芯片中集成有中断控制单元（ICU），该单元包含有两个级联中断控制器，一个为主控制器，一个为从控制器。该中断控制单元就功能而言与工业上标准的 82C59A 是一致的，操作方法也相同。从片的 INT 连接到主片的IR2 信号上构成两片 8259 的级联。

在 TD-PITE 实验系统中，将主控制器的 IR6、IR7 以及从控制器的 IR1 开放出来供实验使用，主片 8259 的 IR4 供系统串口使用。8259 的内部连接及外部管脚引出如图 3.1：

![[微机原理/实验/src/Pasted image 20211121090129.png]]

> 主片地址：`20H` `21H`；从片地址：`A0H` `A1H`

|  位数  |  7  |  6  |  5  |  4  |  3  |  2  |  1  |  0  |
| :--: | :-: | :-: | :-: | :-: | :-: | :-: | :-: | :-: |
| OCW1 |  M7 |  M6 |  M5 |  M4 |  M3 |  M2 |  M1 |  M0 |

```ad-note
title: M7 ~ M0 信号含义
- 0 : 对应 IR 信号上的中断请求得到允许
- 1 : 对应 IR 信号上的中断请求被屏蔽
```

### 3.2. 注意点

在对 8259 进行编程时，首先必须进行初始化。一般先使用 `CLI` 指令将所有可屏蔽中断禁止，然后写入初始化命令字。8259 有一个状态机控制对寄存器的访问，不正确的初始化顺序会造成异常初始化。在初始化主片 8259 时，写入初始化命令字的顺序是：ICW1、ICW2、ICW3、ICW4，初始化从片 8259 的顺序与初始化主片 8259 的顺序是相同的。

系统启动时，主片 8259 已被初始化，且 4 号中断源 IR4 提供给与 PC 连接的串口通信使用，其他中断源被屏蔽。

## 4. 实验 3-1 8259 单中断实验

利用系统总线上中断请求信号 MIR7，设计一个单一中断请求实验。实验接线图如图 3.2 所示，单次脉冲输出与主片 8259 的 IR7 相连，每按动一次单次脉冲，产生一次外部中断，在显示屏上输出一个字符 `7`。

![[微机原理/实验/src/Pasted image 20211121090655.png]]

### 4.1. 实验步骤

1. 按图 3.2 连接实验线路。
2. 编写实验程序，经编译、链接无误后装入系统。
3. 单击按钮，运行实验程序，重复按单次脉冲开关 KK1+，在界面的输出区会显示字符 `7`，说明响应了中断。

### 4.2. 流程图

![[微机原理/实验/src/Pasted image 20211121132723.png]]

### 4.3. 实验程序代码

```c
;========================================================= 
; 文件名: T3-1.asm
; 功能描述: 8259 中断实验，中断源为主片 8259 的 IRQ7 
; 		每产生一次中断输出显示一个字符 7 
;========================================================= 
SSTACK 	SEGMENT STACK 
		DW 32 DUP(?) 
SSTACK ENDS 
CODE SEGMENT 
		ASSUME CS:CODE 
START: 	PUSH DS 
		MOV AX, 0000H 
		MOV DS, AX 
		MOV AX, OFFSET MIR7 ; 取中断入口地址 
		MOV SI, 003CH 		; 中断矢量地址 
		MOV [SI], AX 		; 填 IRQ7 的偏移矢量 
		MOV AX, CS 			; 段地址
		MOV SI, 003EH 
		MOV [SI], AX 		; 填 IRQ7 的段地址矢量 
		CLI 				; IF 清零，关中断
		POP DS 
		;初始化主片 8259 
		MOV AL, 11H 
		OUT 20H, AL 		; ICW1 
		MOV AL, 08H 		
		OUT 21H, AL 		; ICW2 
		MOV AL, 04H 		
		OUT 21H, AL 		; ICW3 
		MOV AL, 01H 		
		OUT 21H, AL 		; ICW4 
		MOV AL, 6FH 		; OCW1 0110 1111 开放 IR4 和 MIR7
		OUT 21H, AL 
		STI 				; IF 设为 1，开中断
AA1: 	NOP 				; 空指令循环
		JMP AA1

; 中断服务程序 
MIR7: 	STI 
		CALL DELAY			; 延迟
		MOV AX, 0137H		; AH=01H, AL=37H 字符 7
		INT 10H 			; 显示字符 7 
		MOV AX, 0120H		; AH=01H, AL=20H 空格
		INT 10H				; 显示空格
		MOV AL, 20H
		OUT 20H, AL 		; 中断结束命令 
		IRET				; 返回
DELAY:	PUSH CX 			; 延迟一段时间
		MOV CX, 0F00H 
AA0: 	PUSH AX 
		POP AX 
		LOOP AA0 
		POP CX 
		RET 
CODE ENDS 
		END START
```

### 4.4. 实验结果

每次按下 KK1+，在屏幕上显示出一个字符 7.


![[微机原理/实验/src/Pasted image 20211228091056.png]]

## 5. 实验 3-2 8259 双中断优先级实验

利用系统总线上中断请求信号 MIR6 和 MIR7,设计一个双中断优先级应用实验，观察 8259 对中断优先级的控制。

实验接线图如图 3.4 所示，KK1+ 和 KK2+ 分别连接到主片 8259 的 IR7 和 IR6 上，当按一次 KK1+ 时，显示屏上显示字符 `7`，按一次 KK2+ 时，显示字符 `6`。

![[微机原理/实验/src/Pasted image 20211121113048.png]]

### 5.1. 实验步骤

1. 按图 3.4 连接实验线路。
2. 编写实验程序，经编译、链接无误后装入系统。
3. 单击 `RUN` 按钮，运行实验程序，重复按单次脉冲开关 KK1+ 和 KK2+， 在界面的输出区会显示字符 `7` 和 `6`，说明响应了中断。
4. 尝试先按 KK1+，再快速按 KK2+，观察 MIR7 和 MIR6 两个中断请求的 优先级，分析实验结果。

### 5.3. 实验程序代码 (TODO)

```c
;========================================================= 
; 文件名: T3-2.asm
; 功能描述: 8259 中断优先级实验
;========================================================= 
SSTACK  SEGMENT STACK 
        DW 32 DUP(?) 
SSTACK ENDS 
CODE SEGMENT 
        ASSUME CS:CODE 
START:  PUSH DS 
        MOV AX, 0000H 
        MOV DS, AX 
        MOV AX, OFFSET MIR7 ; 取中断入口地址 
        MOV SI, 003CH       ; 中断矢量地址 
        MOV [SI], AX        ; 填 IRQ7 的偏移矢量 
        MOV AX, CS          ; 段地址
        MOV SI, 003EH 
        MOV [SI], AX        ; 填 IRQ7 的段地址矢量
        
        MOV AX, OFFSET MIR6 ; 取中断入口地址 
        MOV SI, 0038H       ; 中断矢量地址 
        MOV [SI], AX        ; 填 IRQ6 的偏移矢量 
        MOV AX, CS          ; 段地址
        MOV SI, 003AH 
        MOV [SI], AX        ; 填 IRQ6 的段地址矢量 
        
        CLI                 ; IF 清零，关中断
        POP DS 
        ;初始化主片 8259 
        MOV AL, 11H 
        OUT 20H, AL         ; ICW1 
        MOV AL, 08H         
        OUT 21H, AL         ; ICW2 
        MOV AL, 04H         
        OUT 21H, AL         ; ICW3 
        MOV AL, 01H         
        OUT 21H, AL         ; ICW4 
        MOV AL, 2FH         ; OCW1 0010 1111 开放 IR4 和 MIR7
        OUT 21H, AL 
        STI                 ; IF 设为 1，开中断
AA1:    NOP                 ; 空指令循环
        JMP AA1

; 中断服务程序 
MIR7:   STI 
        CALL DELAY          ; 延迟
        MOV AX, 0137H       ; AH=01H, AL=37H 字符 7
        INT 10H             ; 显示字符 7 
        MOV AX, 0120H       ; AH=01H, AL=20H 空格
        INT 10H             ; 显示空格
        MOV AL, 20H
        OUT 20H, AL         ; 中断结束命令 
        IRET                ; 返回
        
MIR6:   STI 
        CALL DELAY          ; 延迟
        MOV AX, 0136H       ; AH=01H, AL=36H 字符 6
        INT 10H             ; 显示字符 6
        MOV AX, 0120H       ; AH=01H, AL=20H 空格
        INT 10H             ; 显示空格
        MOV AL, 20H
        OUT 20H, AL         ; 中断结束命令 
        IRET                ; 返回

DELAY:  PUSH CX             ; 延迟一段时间
        MOV CX, 0F00H 
AA0:    PUSH AX 
        POP AX 
        LOOP AA0 
        POP CX 
        RET 
CODE ENDS 
        END START
```

### 5.4. 实验结果

按下 KK1+ 键在屏幕上显示字符 7，按下 KK2+ 键在屏幕上显示字符 6. 当同时按下 KK1+ 和 KK2+ 时，屏幕上先显示字符 6，再显示字符 7. 

![[微机原理/实验/src/Pasted image 20211228091143.png]]

## 6. 实验 3-3 8259 级连中断实验

实验接线图如图 3.6 所示，KK1+ 连接到主片 8259 的 IR7 上，KK2+ 连接到从片 8259 的 IR1 上，当按一次 KK1+ 时，显示屏上显示字符 `M7`，按一次 KK2+ 时，显示字符 `S1`。

![[微机原理/实验/src/Pasted image 20211121113503.png]]

### 6.1. 实验步骤

1. 按图 3.6 连接实验线路。
2. 输入程序，编译、链接无误后装入系统。
3. 单击 `RUN` 按钮，运行实验程序，重复按单次脉冲开关 KK1+ 和 KK2+，在界面的输出区会显示字符 `M7` 和 `S1`，说明响应了中断，验证实验程序的正确性。
4. 尝试先按 KK1+，再快速按 KK2+，观察 MIR7 和 SIR1 两个级连中断请求的优先级，分析实验结果。

### 6.2. 实验程序代码

```c
;========================================================= 
; 文件名: T3-3.asm
; 功能描述: 8259 级连中断实验
;========================================================= 
SSTACK  SEGMENT STACK 
        DW 32 DUP(?) 
SSTACK ENDS 
CODE SEGMENT 
        ASSUME CS:CODE 
START:  PUSH DS 
        MOV AX, 0000H 
        MOV DS, AX 
        MOV AX, OFFSET MIR7 ; 取中断入口地址 
        MOV SI, 003CH       ; 中断矢量地址 
        MOV [SI], AX        ; 填 IRQ7 的偏移矢量 
        MOV AX, CS          ; 段地址
        MOV SI, 003EH 
        MOV [SI], AX        ; 填 IRQ7 的段地址矢量
		
		MOV AX, OFFSET SIR1 ; 取中断入口地址 
        MOV SI, 00C4H       ; 中断矢量地址 
        MOV [SI], AX        ; 填 SIR1 的偏移矢量 
        MOV AX, CS          ; 段地址
        MOV SI, 00C6H 
        MOV [SI], AX        ; 填 SIR1 的段地址矢量 
		
        CLI                 ; IF 清零，关中断
        POP DS 
        ;初始化主片 8259 
        MOV AL, 11H 
        OUT 20H, AL         ; ICW1 
        MOV AL, 08H         
        OUT 21H, AL         ; ICW2 
        MOV AL, 04H         
        OUT 21H, AL         ; ICW3 
        MOV AL, 01H         
        OUT 21H, AL         ; ICW4 
		
		MOV AL, 11H 
        OUT 0A0H, AL        ; ICW1 
        MOV AL, 08H         
        OUT 0A1H, AL        ; ICW2 
        MOV AL, 04H         
        OUT 0A1H, AL        ; ICW3 
        MOV AL, 01H         
        OUT 0A1H, AL        ; ICW4 
		
        MOV AL, 6BH         ; 0110 1011
        OUT 21H, AL 
		MOV AL, 0FDH        ; 设置 OCM1，开放 MIR7 和 SIR1
        OUT 0A1H, AL 
		
        STI                 ; IF 设为 1，开中断
AA1:    NOP                 ; 空指令循环
        JMP AA1

; 中断服务程序 
MIR7:   STI 
        CALL DELAY          ; 延迟
        MOV AX, 014DH       ; AH=01H, AL=4DH 字符 M
        INT 10H             
		MOV AX, 0137H       ; AH=01H, AL=37H 字符 7
        INT 10H             
        MOV AX, 0120H       ; AH=01H, AL=20H 空格
        INT 10H
        MOV AL, 20H
        OUT 20H, AL         ; 中断结束命令 
        IRET                ; 返回
		
SIR1:   STI 
        CALL DELAY          ; 延迟
        MOV AX, 0153H       ; AH=01H, AL=53H 字符 S
        INT 10H             
		MOV AX, 0131H       ; AH=01H, AL=31H 字符 1
        INT 10H             
        MOV AX, 0120H       ; AH=01H, AL=20H 空格
        INT 10H             
        MOV AL, 20H
        OUT 20H, AL         ; 中断结束命令 
        IRET                ; 返回

DELAY:  PUSH CX             ; 延迟一段时间
        MOV CX, 0F00H 
AA0:    PUSH AX 
        POP AX 
        LOOP AA0 
        POP CX 
        RET 
CODE ENDS 
        END START
```

### 6.3. 实验结果

### 6.4. 二进制转格雷码

#### C 语言实现

```c
int B2G(int x) {
	return x ^ (x >> 1);
}
```

#### 汇编实现

```c
DATAS SEGMENT
    INFO  DB 'the result of GR to ASCII is:','$'
    GR_CODE DB ?
    BIN_CODE DB ?
DATAS ENDS

CODES SEGMENT
    ASSUME CS:CODES,DS:DATAS,SS:STACKS
START:
    MOV AX,DATAS
    MOV DS,AX
    
    MOV DX,OFFSET INFO      ; 取字符串 INFO 的偏移地址
    MOV AH,09H    
    INT 21H                 ; 将 INFO 的内容显示出来
    CALL ENTERR
    
    MOV BIN_CODE,1100B       ; 二进制为 1100B
    MOV GR_CODE,0
    MOV AL,GR_CODE
	MOV BL, AL              ; BL=GR_CODE
OP:
    SHR BL,1                ; BL=x>>1
    XOR BL,AL               ; BL=(x>>1)^x

    ADD BL,30H              ; BL='0'+BL
    MOV BIN_CODE,BL
    MOV DL,BIN_CODE
    
    MOV AH,02H
    INT 21H                 ; 显示，结果为 4
    MOV AH,4CH
    INT 21H

ENTERR:
       MOV AH,02H
       MOV DL,0DH
       INT 21H    ; 回车
       MOV AH,02H
       MOV DL,0AH
       INT 21H    ; 换行
       RET 
CODES ENDS
    END START
```

![[微机原理/实验/src/Pasted image 20211228113948.png]]
