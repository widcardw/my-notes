---
mindmap-plugin: basic
---

# 网络层

## 基本概念
- OSI 参考模型的第三层
- 主要任务
   - 把分组从源主机经过适当的路径发送到目的主机
   - 向传输层提供端到端的数据传送服务
      - 面向连接
         - 虚电路
      - 无连接
         - 数据报
   - 解决问题
      - 路由选择
      - 拥塞控制
      - 网际互连
- 网络互联设备的工作层次
   - 集线器
      - 物理层
   - 交换机
      - 链路层
   - 路由器
      - 网络层

## IPv4 协议
- 概念及主要特点
   - 是 TCP/IP 体系中最重要的协议之一
   - 配套 4 个协议
      - 地址解析协议 ARP
      - 逆地址解析协议 RARP
      - 网际控制报文协议 ICMP
      - 网际组管协议 IGMP
   - ==无连接、不可靠==的分组传输协议
   - 屏蔽链路层、物理层协议和实现技术上的差异
   - 点-点网络层通信协议
- IPv4 分组格式
   最大 65535B
   - 分组头
      - 固定长度=20B，可变长度≤40B
      - 格式
         - ![[计算机网络/src/屏幕截图 2021-12-05 143054.jpg]]
      - 具体描述
         - IP 协议版本
         - 首部长度 4 位，最大表示 15，一个单位 4B
            因此首部最大值为 60B
         - 服务类型
         - 总长度 16 位，最大可表示 65535
         - IP 分组的标识
         - 分片标志：3 位中后 2 位
            - MF : 还有分片
            - DF : 不允许分片
         - 片偏移
            - 某片在原分组的相对位置
            - 8B 为单位
         - 生存时间
            - 每通过一次路由 TTL-1
         - 协议
            - ICMP, IGMP, TCP, UDP, OSPF
         - 首部校验和
            - 首部每 16 位求和
         - 源地址、目的地址 IP
   - 数据
- IPv4 地址
   - 基本概念
      - TCP/IP 协议的网络层使用的地址标识符
      - 32 位二进制地址
      - 发展阶段
         - 标准分类
            - 网络号+主机号
         - 划分子网
            - 网络号+子网号+主机号（3级结构）
         - 构成超网 CIDR
            - 将剩余 IP 地址按可变大小地址块分配
         - 地址转换 NAT
            - 短时间内解决IP地址短缺问题
   - 标准分类
      - 点分十进制
      - 五类
         - 类别|地址范围|网络数|每个网络主机数|
         - A|--1.0.0.0~127.255.255.255|---125|16M-2|
         - B|128.0.0.0~191.255.255.255|16K-16|65534|
         - C|192.0.0.0~223.255.255.255|2M-256|'254'|
         - D|224.0.0.0~239.255.255.255|------|-----|
         - E|240.0.0.0~247.255.255.255|------|-----|
      - ==专用 IP 地址==
         - 用于不接入 Internet 的内部网络
         - A 10 1
         - B 172.16~172.31 16
         - C 192.168.0~192.168.255 256
      - 特殊 IP 地址
         - 主机号全 0 : 网络地址
         - 网络号全 0 : 主机地址
         - 主机号全 1 : 直接广播地址
         - 全 1 地址 : 受限广播地址
         - 网络号 127 : 回送地址
         - 全 0 地址 : 本机
      - 网络掩码
         - 和 IP 地址==与运算==得到网络号
         - A 255.0.0.0
         - B 255.255.0.0
         - C 255.255.255.0
      - 分配方法
         - 为每个网络接口分配一个 IP 地址
         - 为多归属主机的每一个网络接口分配一个 IP 地址
         - 为一个网络接口分配多个 IP 地址
         - 路由器（第三层交换机）需要分配多个 IP 地址
         - 网桥、交换机、集线器不属于网络层设备，不需分配
   - 划分子网的三级地址结构
      - 标准分类的问题
         - IP 地址空间的利用率有限
         - 每个物理网络分配一个网络号，路由表太大，性能变差
      - 结构
         - 网络号+子网号+主机号
      - 路由选择过程
         - 转发到网络
            - 转发到子网
               - 转发到主机
      - 子网掩码
         - 子网掩码 & IP 地址 = 子网地址
      - 举例
         - 将 C 类网络 202.119.116.0 划分为 4 个
            - 借用 2 位主机号，剩余 6 位主机号
            - 子网掩码 255.255.255.192
            - 1
               - 1~62
            - 2
               - 65~126
            - 3
               - 129~190
            - 4
               - 193~254
   - 无类别域间路由 CIDR
      - 使用==变长子网掩码 VLSM==
         - 提高 IP 地址资源利用率
         - 消除传统的 ABC 类及划分子网概念
         - 按需分配
      - 网络前缀
         - 200.16.23.1/20
            - ==11001000_00010000_0001==0111_00000001
         - 前 20 位为网络前缀，后 12 位为主机号
         - 将 200.24.16.0/20 划分成 8 个等长的网络
            - 前缀增加 3 位
               - 200.24.16.0/23
               - 200.24.18.0/23
               - ...
               - 200.24.30.0/23
      - 路由聚合
         - 一个 CIDR 地址块可以表示很多地址，它使得路由表中的==一个表项==可以表示==很多个==原来传统分类地址的路由
   - 网络地址转换 NAT
      - ==专用地址==与全局 IP 地址转换
      - 两种具体形式
         - 只完成专用 IP 和全局 IP 的转换
         - 完成上述工作同时，转换传输层 TCP 或 UDP 端口号
      - 工作原理
         - 内部 IP 10.0.1.1 希望访问 Internet 135.2.1.1
            - 分组① S=10.0.1.1:3342, D=135.2.1.1:80
         - 分组①→NAT，专用 IP→全局 IP
            - 得到分组② S=202.0.1.1:5001, D=135.2.1.1:80
         - 分组②→Internet 135.2.1.1
            - 返回分组③ S=135.2.1.1:80, D=202.0.1.1:5001
         - 分组③→NAT→分组④ S=135.2.1.1:80, D=10.0.1.1:3342
            - 分组④→内部 IP 10.0.1.1
      - 评价
         - 缓解 IP 地址短缺问题
         - 违反 IP 设计的初衷，变成了==面向连接==
         - 不同协议要有不同的调整
         - P2P 实现困难
   - IP 地址获取
      - 手动配置(静态)
      - 动态主机配置协议 DHCP

## 路由选择与分组交付
- 分组交付
   - 在互连网络中路由器转发 IP 分组的过程
   - 分类
      - 直接交付
         - 源主机与目的主机==在同一网络==
         - 转发在最后一个路由器到目的主机
      - 间接交付
         - 源主机与目的主机==不在同一网络==
- 路由选择
   - ==路由选择算法==
      - 源与目的间有多条传输路径
      - 分组交付的路径是由==路由选择算法==来决定的
      - ==选择最佳路径==分组转发
      - 生成==路由表==
   - 默认路由器（默认网关）
      - 第一跳路由器
   - 算法要求
      - 正确、稳定、公平
      - 尽量简单
      - 能够适应网络拓扑和通信量变化
      - 算法应该是最佳的
   - 算法分类
      - 静态路由选择算法
         - 非自适应
      - 动态路由选择算法
         - 自适应
            - 距离向量算法 DV
               - BF
               - 邻居交换信息
            - 链路状态算法 LS
               - Dijkstra
               - 所有路由器有完整的拓扑、链路费用信息
   - 路由表
      - 分类
         - 静态
            - 人工建立
         - 动态
            - 自动路由选择
      - 路由表的生成和使用
         - 每台路由器保存一张路由表
         - |子网掩码|目的地址|下一跳地址|转发端口|<br>|255.255.255.0|202.1.1.0|202.1.5.1|S1|<br>|255.255.255.0|202.1.2.0|202.1.5.1|S1|<br>|255.255.255.0|202.1.3.0|---------|E0|<br>|255.255.255.0|202.1.4.0|---------|E1|<br>|--0.--0.--0.0|--0.0.0.0|202.1.4.1|E1|
         - ![[计算机网络/src/Pasted image 20211205191943.png]]
   - IP 路由汇聚
      - 路由表中一个表项可以表示多个传统分类地址的路由
      - 使用 CIDR 地址
         - 路由表项由“网络前缀”和下一跳地址构成
         - 不止一个匹配结果
            - ==最长前缀匹配==
- 路由选择协议
   - 基本思路
      - 化整为零，分而治之
      - 分层次的路由选择协议
      - 实现路由表中路由信息的动态更新
   - 自治系统 AS
      - 为实现分层次的路由选择
      - 在单一技术管理下的一组路由器
   - 分类
      - 域内路由选择
         - 内部网关协议 IGP
            - 自治系统内部路由器间交换
            - ==路由信息协议 RIP==
            - ==开放最短路径优先协议 OSPF==
      - 域间路由选择
         - 外部网关协议 EGP
            - 连接不同 AS 的路由器间交换路由信息
            - ==边界网关协议 BGP-4==
- 路由信息协议 RIP
   - 分布式、基于 ==DV 算法==
   - 距离=**跳数**
   - 规定
      - 每 30 秒交换信息一次
      - 表项超过 180 秒未更新，则置“无效”
      - “无效”后 120 秒未刷新，则删除
      - 最大可达 15 跳
   - 特点
      - 实现简单
      - 适用于较小的网络
   - 报文格式
      - RIP报文→UDP数据报→IP数据报
   - 慢收敛问题
      - 水平分割
      - 带触发更新的毒性逆转
- 最短路径优先 OSPF
   - 特点
      - 基于 ==Dijkstra 算法==
      - 建立链路状态数据库
      - ==最短路径树==
   - 优缺点
      - 以最短路径树形成的路由一定最优
      - 需要路由器有较强的计算能力
- 外部网关协议 BGP
   - 设计思想
      - 知道==直接互连==的网络信息
      - ==扩散==知道的路由信息
      - 计算路由
      - 把路由信息传给其他路由器
      - 至少一个路由器作为==“BGP发言人”==
   - BGP报文
      - BGP报文主体+首部→BGP报文+TCP首部→TCP报文+IP首部→IP报文
- 路由器
   - 具有多个输入端口和输出端口的专用计算机
   - 建立维护路由表、提供网络间分组转发功能

## 地址解析协议
- ARP
   - 在实际网络链路上传送数据帧时需要==MAC地址==
   - ARP高速缓存=>==IP地址-MAC地址映射表==
      - 减少通信量
      - 减少广播、加快访问速度
      - ARP请求->获得MAC地址
   - 注意点
      - ARP协议是解决==同一局域网==上的主机或路由器的==IP地址找到MAC地址的映射==问题
      - 从IP地址到硬件地址的解析是自动进行的，==对用户透明==
      - 具有时效性
   - ARP服务的情况
      - 主机→同一网络另一主机
      - 主机→另一网络的主机
      - 路由器→下一跳路由器
      - 路由器→直连网络的主机
- RARP
   - MAC地址-IP映射表

## Internet 控制报文协议 ICMP
- 允许主机或路由器==报告差错情况和提供有关异常==
- 特点
   - 本身是网络层协议，但需要封装成==IP分组==
   - 是IP协议的组成部分
   - 差错报告采用==路由器-源主机==模式，只向源主机报告
   - 不能纠正差错
- ICMP报文的类型
   - 目的主机不可达
   - 源站抑制
   - 参数问题
   - 超时
   - 重定向
      - 找到更好的路由
   - 回应请求/回应应答
   - 时间戳请求和应答

## IP 多播与 IGMP 协议
- IP 多播
   - 发送一次数据 多播组成员都能收到
   - D 类 IP 地址支持多播
      - 224.0.0.0 保留
      - 224.0.0.1 指定为本网中所有参加多播的主机使用
      - 224.0.0.2 指定为本网中所有参加多播的路由器使用
      - 224.0.1.0~238.255.255.255 Internet 上使用的多播地址
      - 239.0.0.0~239.255.255.255 限制在一个组织内使用的多播地址
   - 特征
      - 只能用于目的地址
      - 仅赋予多播组
   - 实现方法
      - 定义组地址
      - 接收者加入或退出
      - 发送者只管向多播地址发
      - 路由器建立多播传递树
- IGMP 协议
   - 在多播环境下使用的协议
      - 使多播路由器知道多播成员信息
   - 多播路由器
      - 建立多播路由表
      - 多播 IP 分组的转发
      - 多播路由选择
         - 算法
            - TRPB
            - tunneling
            - core
         - 协议
            - 域内/域间
            - 有源树/共享树
   - 隧道技术
      - 解决遇到不支持多播协议的路由器或网络的问题
      - 将多播加上头部 变成单播

## 移动 IP
- 出现背景
   - 移动通信的发展
   - 如何处理移动设备的 IP
- 特征
   - 移动主机在改变接入点时 不必改变其IP 保持已有通信的连续性
   - 通过永久的IP地址 连接到任何网络
   - 切换到新网络 保持正常通信
- 功能实体
   - 移动主机
   - 家乡代理
   - 外地代理
   - 通信对端节点
- 工作原理
   - 代理发现
      - 找到移动代理并获得转交地址
   - 注册
      - 使家乡代理知道移动主机当前转交的IP
      - 更新即将到期的注册
      - 未配置或不知道家乡地址时获得家乡地址
   - 分组路由
      - 移动主机接收/发送单播分组
   - 注销
      - 当移动代理回到家乡网络 到家乡代理注销

## IPv6
- 背景
   - IPv4的局限性
- 特征
   - 新的分组头格式
   - 128位地址空间
   - 有效的分级寻址和路由结构
   - 支持地址自动配置
   - 内置安全性
   - 更好地支持QoS
   - 协议更加简洁
   - 可扩展性
- IPv6地址
   - 冒号16进制表示法
   - 零压缩法
      - 压缩前导零
      - 连续多组0位段 压缩为一对冒号（仅支持一个连续段）
   - 不支持子网掩码 支持前缀长度表示法
- 分组结构和基本报头
   - 基本报头
      - ![[计算机网络/src/Pasted image 20211214214552.png]]
      - 40B
   - 多个扩展头
   - 高层协议数据单元
- IPv4到IPv6的过渡
   - 双协议层和双协议栈结构
   - 隧道技术
      - 通过IPv4网络传输IPv6分组(加分组头)
      - 隧道类型
         - 路由器-路由器
         - 主机-路由器/路由器-主机
         - 主机-主机