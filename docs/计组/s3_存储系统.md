# 第 3 章 存储系统

> [!info] 内容
> 1. 存储器的分类
> 2. 层次化存储器的基本结构
> 3. 半导体随机存取存储器
> 	1. SRAM
> 	2. DRAM
> 	3. Flash 存储器
> 4. 主存储器
> 	1. DRAM 芯片和内存条
> 	2. 多模块存储器
> 	3. 主存和 CPU 之间的连接
> 5. 外部存储器
> 	1. 磁盘存储器
> 	2. 固态硬盘 SSD
> 6. 高速缓冲存储器 Cache
> 	1. 基本原理；Cache 与主存之间的映射方式
> 	2. Cache 中主存块的替换算法；Cache 写策略
> 7. 虚拟存储器
> 	1. 虚拟存储器的基本概念
> 	2. 页式虚拟存储器：基本原理、页表、地址转换、TLB
> 	3. 段式虚拟存储器的基本原理；段页式虚拟存储器的基本原理

## 3.1. 存储器概述

### 3.1.1. 分类

#### 1. 按在计算机中的作用分类

- 主存储器（内存储器）
- 辅助存储器（外存储器）
- 高速缓冲存储器

#### 2. 按存储介质分类

- 磁表面存储器（磁带、磁带）
- 磁芯存储器
- 半导体存储器（MOS 型存储器、双极型存储器）
- 光存储器（光盘）

#### 3. 按存取方式

- 随机存储器 RAM
	- 静态 SRAM
	- 动态 DRAM
- 只读存储器 ROM
- 串行访问存储器：需要按其物理位置的先后顺序寻址，包括顺序存取存储器（磁带）与直接存取存储器（磁盘、光盘）

#### 4. 按信息的可保存性分类

- 易失性：断电后存储信息消失，如 RAM
- 非易失性：断电后仍然保持，如 ROM

### 3.1.2. 存储器的性能指标

> [!tip] 3 个主要性能指标
> - 存储容量 = 存储字数 × 字长（如 1M × 8 位）
> - 单位成本 = 总成本 / 总容量
> - 存储速度：数据传输率 = 数据的宽度 / 存储周期
> 	- 存取时间：从启动一次存储器操作到完成该操作所经历的时间
> 	- 存取周期：读写周期 / 访问周期，指存储器进行一次完整的读写操作所需的全部时间
> 	- 主存带宽：数据传输率，每秒从主存进出信息的最大数量

存取时间不等于存储周期，通常存储周期大于存取时间。对任何一种存储器，在读写操作之后，总要有一段内部状态的复原时间。

### 3.1.3. 多级层次的存储系统

为解决存储系统大容量、高速度、低成本 3 个相互制约的矛盾，通常采用多级存储器结构。

![[public/jz/jz03mem534t.png]]

主要思想史上一层的存储器作为低一层存储器的高速缓存。

在主存-辅存层的不断发展中，逐渐形成了虚拟存储系统，在这个系统中程序员编程的地址范围与虚拟存储器的地址空间相对应。对具有虚拟存储器的计算机而言，编程时可用的地址空间远大于主存空间。

## 3.2. 主存储器

主存储器由 DRAM 实现，靠处理器的那一层（Cache）则由 SRAM 实现，它们都属于易失性存储器。DRAM 的每位价格低于 SRAM ，速度也慢于 SRAM 。

### 3.2.1. SRAM 芯片与 DRAM 芯片

#### 1. SRAM 的工作原理

静态 RAM 的存储元是用双稳态触发器（六个晶体管 MOS）来记忆信息的，因此即使信息被读出后，仍然保持原状态而不需要再生。

SRAM 的存取速度快，但集成度低，功耗较大，价格昂贵，一般用于 Cache 。

#### 2. DRAM 工作原理

动态 RAM 是利用存储元电路中栅极电容上的电荷来存储信息的，通常只使用一个晶体管，所以比 SRAM 的密度要高很多。相比 SRAM，DRAM 具有容易集成，价位低，功耗低等优点，但 DRAM 的存取速度比 SRAM 慢，一般用于大容量的主存系统。

DRAM 电容上的电荷一般只能维持 1 ~ 2 ms，因此即使电源不断电，信息也会自动消失，为此每隔一段时间必须刷新，通常取 2 ms，称为刷新周期。常用刷新方式有 3 种：

- 集中刷新：在一个刷新周期内，利用一段固定时间，依次逐一再生，在此期间停止对存储器的读写操作，称为“死时间”。
- 分散刷新：把对每行的刷新分散到各个工作周期中。这样，一个存储器的系统工作周期分为两部分：前半部分正常读、写或保持，后半部分用于刷新。没有死区，但是加长了系统存取周期，降低了整机的速度。
- 异步刷新：前两种的结合，将刷新周期除以行数，得到两次刷新操作之间的时间间隔 $t$，利用逻辑电路每隔时间 $t$ 产生一次刷新请求。这样避免使 CPU 连续等待过长的时间，而且减少了刷新次数，从根本上提高了整机的工作效率。

> [!caution]
> - 刷新对 CPU 是透明的，即刷新不依赖于外部的访问
> - 动态 RAM 的刷新单位是行，由芯片内部自行生成行地址
> - 刷新操作类似于读操作，但又有所不同
> - 刷新时不需要选片，即整个存储器中的所有芯片同时被刷新

#### 3. DRAM 芯片的读写周期

在读周期中，为使芯片能正确接收行、列地址，在 $\overline{RAS}$ 有效前将行地址送到芯片的地址引脚，$\overline{CAS}$ 滞后 $\overline{RAS}$ 一段时间，在 $\overline{CAS}$ 有效前再将列地址送到芯片的地址引脚，$\overline{RAS}, \overline{CAS}$ 应至少保持 $t_{RAS}$ 和 $t_{CAS}$ 的时间。在读周期中 $\overline{WE}$ 为高电平，并在 $\overline{CAS}$ 有效前建立。

在写周期中，行列选通的时序关系和读周期相同。在写周期中 $\overline{WE}$ 为低电平，在 $\overline{CAS}$ 有效前建立。为保证数据的可靠写入，写数据必须在 $\overline{CAS}$ 有效前在数据总线上保持稳定。

读（写）周期时间 $t_{RC}(t_{WC})$ 表示 DRAM 芯片进行两次连续读（写）操作必须间隔的时间。

![[public/jz/jzdramwr.png]]

#### 4. SRAM 和 DRAM 比较

|            |   SRAM   |   DRAM   |
|:----------:|:--------:|:--------:|
|  存储信息  |  触发器  |   电容   |
| 破坏性读出 |    否    |    是    |
|  需要刷新  |    否    |    是    |
| 送行列地址 |  同时送  |  分两次  |
|  运行速度  |    快    |    慢    |
|   集成度   |    低    |    高    |
|  存储成本  |    高    |    低    |
|  主要用途  | 高速缓存 | 主机内存 |

#### 5. 存储器芯片的内部结构

存储器芯片由存储体、I/O 读写电路、地址译码和控制电路等部分组成。

![[public/jz/jzmemory.png]]

1. 存储体是存储单元的集合，由行选择线 X 和列选择线 Y 来选择所访问的单元，存储体的相同行、列上的位同时被读出或写入
2. 地址译码器，用来将地址转换为译码输出线上的高电平，以便驱动相应的读写电路
3. I/O 控制电路，用以控制被选中的单元的读出或写入，具有放大信息的作用。
4. 片选控制信号。单个芯片容量太小，往往满足不了计算机对存储容量的需求，因此需要用一定量的芯片进行存储器的扩展。访问字时必须选中该存储字所在的芯片，才能从芯片中选到字。
5. 读写控制信号，根据 CPU 给出的读命令或写命令，控制被选中的单元进行读写。

### 3.2.2. 只读存储器

#### 1. ROM 的特点

支持随机存取，一旦有了信息，就不能轻易改变，即使掉电也不会丢失，在计算机系统中是只供读出的存储器。

> [!tip] 优点
> 1. 结构简单，所以密度比可读写存储器的高
> 2. 具有非易失性，可靠性高

#### 2. ROM 的类型

##### 掩模式只读存储器 MROM

内容由制造厂商直接写入，之后任何人无法更改。可靠性高，集成度高，价格便宜，但灵活性差

##### 一次可编程只读存储器 PROM

可以实现一次性编程的只读存储器。允许用户利用专门的设备（编程器）写入自己的程序，一旦写入，无法改变。

##### 可擦除可编程只读存储器 EPROM

可以由用户利用编程器写入信息，而且可以对其内容进行多次改写，但编程次数优先，写入时间过长。

##### Flash 存储器

在 EPROM 和 E$^2$PROM 的基础上发展起来的，特点是既可在不加电的情况下长期保存信息，又能在线进行快速擦除和重写。

##### 固态硬盘 SSD

基于闪存的固态硬盘是用固态电子存储芯片阵列制成的硬盘，由控制单元和存储单元组成。保留了 Flash 存储器长期保存信息、快速擦除与重写的特性，相比传统，读写速度快、低功耗，但价格高。

### 3.2.3. 主存储器的基本组成

![[public/jz/jz03memorydfasgverg.png]]

上图为主存储器的基本框图，其中由一个个存储 0 或 1 的记忆单元（存储元间）构成的存储矩阵（存储体）是存储器的核心部分。记忆单元是具有两种稳态的能表示二进制 0 和 1 的物理器件。为了存取存储体中的信息，必须对存储单元编号（编址）。编址单位是指具有相同地址的那些存储元件构成的一个单位，可按字节编址，也可按字编址。现代计算机通常采用字节编址方式。

36 位地址的最大寻址范围是 $0\sim 2^{36}-1$，即地址从 0 开始编号。采用 64 位数据线，在按字节编址方式下，每次最多可存取 8 个单元的内容。芯片总容量为 $2^{36}\times 64$ 位。

DRAM 芯片容量较大，地址位数较多，为了减少芯片的地址引脚数，通常采用地址引脚复用技术，行地址和列地址通过相同的引脚分先后两次输入，这样地址引脚数可以减少一半。

### 3.2.4. 多模块存储器

是一种空间并行技术，利用多个结构完全相同的存储块的并行工作来提高存储器的吞吐率。常用的有单体单体多字存储器和多体低位交叉存储器。

> CPU 的速度比存储器的快，若同时从存储器中取出 $n$ 条指令，就可充分利用 CPU 资源，提高运行速度，多体交叉存储器就是基于这种思想提出的。

#### 1. 单体多字存储器

存储器中只有一个存储体，每个存储单元存储 $m$ 个字，总线宽度也为 $m$ 个字。一次并行读出 $m$ 个字，地址必须顺序排列并处于同一个存储单元。

单体多字系统在一个存取周期内，从同一地址取出 $m$ 条指令，然后将指令逐条送至 CPU 执行，即每隔 $1/m$ 存取周期，CPU 向主存取一条指令。这提高了单体存储器的工作速度。

> 缺点：指令和数据在主存内必须是连续存放的，一旦遇到转移指令，或操作数不能连续存放，这种方法的效果就不明显。

#### 2. 多体并行存储器

由多体模块组成，每个模块都有相同的容量和存取速度，各模块都有独立的读写控制电路、地址寄存器、数据寄存器。既能并行工作，又能交叉工作。

##### 高位交叉编址（顺序方式）

高位地址表示体号，低位地址为体内地址。

![[public/jz/jzjcrthgrte.png]]

高位交叉方式下，总是把低位的体内地址送到由高位体号确定的模块内进行译码。访问一个连续主存块时，总是先在一个模块内访问，等到该模块访问完才转到下一个模块访问，CPU 总是按顺序访问存储模块，各模块不能被并行访问，不能提高存储器的吞吐率。

##### 低位交叉编址（交叉方式）

低地址为体号，高地址为体内地址。每个模块按 “模 $m$” 交叉编址，模块号 = 单元地址 % $m$，假定有 $m$ 个模块，每个模块有 $k$ 个单元，则 $0,m,\cdots,(k-1)m$ 单元位于 $M_{0}$，$1, m+1, \cdots, (k-1)m+1$ 位于 $M_{1}$。

![[public/jz/jzjcrega3.png]]

在该方式下，总是把高位的体内地址送到由低位体号确定的模块内进行译码。程序连续存放在相邻模块中，因此称采用此编址方式的存储器为交叉存储器。采用这种方式可在不改变每个模块存取周期的前提下，采用流水线的方式并行存取，提高存储器的带宽。

设模块字长等于数据总线款地，模块存取一个字的存取周期为 $T$，总线传送周期为 $r$，为实现流水线方式存取，存储器交叉模块数应大于等于 $m=T/r$，$m$ 称为交叉存取度。

![[public/jz/jzfger4me.png]]

流水线方式连续存取 $m$ 个字所需时间为 $t_{1}=T+(m-1)r$，顺序方式需要 $t_{2}=mT$

## 3.3. 主存与 CPU 的连接

### 3.3.1. 连接原理

1. 主存储器通过数据总线、地址总线、控制总线与 CPU 连接
2. 数据总线的位数与工作频率的乘积正比于数据传输率
3. 地址总线的位数决定了最大内存空间
4. 控制总线（读/写）指出总线周期的类型和本次输入/输出操作完成的时刻

![[public/jz/jz03structure234w.png]]

单个芯片的容量不可能很大，往往通过存储芯片扩展技术，将多个芯片集成在一个内存条上，然后由多个内存条及主板上的 ROM 芯片组成计算机所需的主存空间，再通过总线与 CPU 相连。

![[public/jz/jzconnect354.png]]

内存条插槽就是存储器总线，内存条中的信息通过内存条的引脚，再通过插槽内的阴险连接到主板上，通过主板上的导线连接到 CPU 芯片。

### 3.3.2. 主存容量的扩展

由于单个存储芯片的容量是有限的，它在字数或字长方面与实际存储器的要求都有差距，需要在==字==或==位==两方面进行扩充。

#### 1. 位扩展法

CPU 的数据线数与存储芯片的数据位数不一定相等，此时必须对存储芯片扩位（位扩展，用多个存储器件对字长进行扩充，增加存储字长），使其数据位数与 CPU 的数据线数相等。

连接方式是将多个芯片的地址端、片选端和读写控制端相应并联，数据端分别引出。

![[public/jz/jzweiextend.png]]

8 片 8K × 1 位的 RAM 芯片组成 8K × 8 位的存储器。8 片的地址线 $A_{12}\sim A_{0}, \overline{CS}, \overline{WE}$ 都分别连在一起，每片的数据线依次作为 CPU 数据线的一位。

> 在某一时刻选中所有芯片，同时取出所有片上的那一个数据，$\overline{CS}$ 要连接到所有芯片

#### 2. 字扩展法

增加存储器中字的数量，位数不变。字扩展将芯片的地址线、数据线、读写控制线相应并联，而由片选信号来区分各芯片的地址范围。

![[public/jz/jzziextend.png]]

用 4 片 16K × 8 位的 RAM 芯片组成 64K ÷ 8 位的存储器。4 片 RAM 的数据线 $D_{0}\sim D_{7}$ 和 $\overline{WE}$ 都分别连在一起，$A_{15}A_{14}$ 作为片选信号，$A_{15}A_{14}=00$ 时，译码器输出端 0 有效，选中 1 号芯片；其他以此类推。

> 某一时刻只选中部分芯片，通过片选信号 $\overline{CS}$ 或采用译码器设计连接到相应的芯片

#### 3. 字位同时扩展

用 8 片 16K × 4 位的 RAM 组成 64K × 8 位的存储器，每两片构成一组 16K× 8 位的存储器（位扩展），4 组构成 64K × 8 位的存储器（字扩展）。地址线 $A_{15}A_{14}$ 经译码器得到 4 个片选信号，$A_{15}A_{14}=00$ 时，输出端 0 有效，选中第一组芯片；其他以此类推。

![[public/jz/jzextboth.png]]

> 采用同时扩展时，各芯片连接地址线的方式相同，但链接数据线的方式不同，且需要通过片选信号 $\overline{CS}$ 或采用译码器设计连接到相应的芯片

### 3.3.3. 存储芯片的地址分配和片选

CPU 要实现对存储单元的访问，首先要片选，然后为选中的芯片按地址码选择相应的存储单元，以进行数据的存取，进行字选。

字选通常由 CPU 送出的 $N$ 条低位地址线完成，地址线直接连接到所有存储芯片的地址输入端。片选信号的产生分为线选法和译码片选法。

#### 1. 线选法

用除片内寻址外的高地址线直接分别接至各个芯片的片选端，当某地址线信息为 0 时，就选中与之对应的存储芯片。这些片选地址线每次寻址时只能有一位有效，不允许同时有多位有效，这样能保证每次只选中一个芯片（组）。

4 片 2K × 8 位存储芯片构成 8K × 8 位存储器，各芯片的片选信号如下，其中低位地址线 $A_{10}\sim A_{0}$ 作为字选线，用于片内寻址。

| 芯片 | $A_{14}\sim A_{11}$ |
|:----:|:-------------------:|
| #0   | 1110                |
| #1   | 1101                |
| #2   | 1011                |
| #3   | 0111                | 

> [!tip] 优缺点
> - 不需要地址译码，线路简单
> - 地址空间不均匀，选片的地址线必须分时为低电平，不能充分利用系统的存储器空间，造成地址的浪费

#### 2. 译码片选法

用除片内寻址外的高位地址线通过==地址译码器==芯片产生片选信号。

8 片 8K × 8 位的存储芯片组成 64K × 8 位的存储器（地址线 16 位，数据线 8 位），需要 8 个片选信号；若采用线选法，除去片内寻址的 13 位地址线，仅余高 3 位，不足以产生 8 个片选信号。因此，采用译码片选法，用一片 74LS138 作为地址译码器，$A_{15}A_{14}A_{13}=000$ 时选中第一片；后面以此类推。

### 3.3.4. 存储器于 CPU 连接

#### 1. 合理选择存储芯片

主要是芯片类型（RAM 或 ROM）和数量。ROM 存放系统程序、标准子程序、常量，RAM 是为用户编程而设置的。

#### 2. 地址块的连接

存储芯片容量不同，地址线数目也不同，CPU 的地址线数往往比存储芯片的地址线数目要多。通常将 CPU 地址线的低位与存储芯片的地址线相连，以选择芯片的某一单元（字选），这部分的译码是由芯片的片内逻辑完成的。

CPU 地址线的高位则在扩充存储芯片时使用，用来选择存储芯片（片选），这部分译码由外接译码器逻辑完成。

#### 3. 数据线的连接

CPU 的数据线与存储芯片的数据线不一定相等，在相等时可以直接连接；不相等时必须对存储芯片扩位，使数据位与  CPU 数据线数相等。

#### 4. 读/写命令线的连接

CPU 的读写命令线一般可直接与存储芯片的读写控制端连接，通常为高电平读，低电平写。有些 CPU 的读写命令线是分开的，此时 CPU 的读命令线与存储芯片的允许读控制端相连，而 CPU 的写，命令线应与存储芯片的允许写控制相连。

#### 5. 片选线的连接

存储器由许多存储芯片叠加而成，那一片被选中取决于该存储芯片的片选控制信号 $\overline{CS}$ 是否能接收到来自 CPU 的片选有效信号。

片选有效信号与 CPU 的访存控制信号 $\overline{MREQ}$ 有关，因为只有当 CPU 要求访存时，才要求选中存储芯片。




